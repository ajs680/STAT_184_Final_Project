---
title: "STAT 184: Final Project"
subtitle: "How COVID-19 Affects Different Counties & Demographics"
author: "Adam Seiff & Kelly Cooper"
output: html_notebook
---
## Front Matter
```{r}
# clean up workspace environment
rm(list = ls())

# packages used for the project
library(tidyr)
library(ggplot2)
library(DataComputing)
library(data.table)
```

## Guiding Question
**How are cases COVID-19 distributed amongst Americans of different demographics (age and race) and across different counties? For instance, are counties with older populations more likely to have a higher rate of COVID-19 cases than those with younger populations?**

## Loading & Cleaning the Data

### COVID-19 Data
```{r}
COVID <- read.csv("NEW us-counties (Apr 23).csv")

COVIDFiltered <- COVID %>%
  mutate(date = gsub(pattern = "/| +", replacement = "-", date)) %>%
  mutate(county = gsub(pattern = "^ +| +$", replacement = "", county)) %>%
  mutate(county = gsub(pattern = " {2,}", replacement = " ", county)) %>%
  mutate(county = gsub(pattern = "^[a-z]", replacement = "[A-Z]", county)) %>%
  mutate(state = gsub(pattern = "^ +| +$", replacement = "", state)) %>%
  mutate(state = gsub(pattern = " {2,}", replacement = " ", state)) %>%
  mutate(state = gsub(pattern = "^[a-z]", replacement = "[A-Z]", state)) %>%
  filter(date == "2020-04-23", is.numeric(cases) == TRUE) %>%
  select(county, state, cases)

COVIDFiltered 
```

### Census Data
```{r}
Census <- read.csv("Year11.csv")

CensusFiltered <- Census %>%
  mutate(White = NHWA_MALE + NHWA_FEMALE) %>%
  mutate(Black = NHBA_MALE + NHBA_FEMALE) %>%
  mutate(Hispanic = H_MALE + H_FEMALE) %>%
  mutate(Asian = NHAA_MALE + NHAA_FEMALE) %>%
  mutate(Native_American = NHIA_MALE + NHIA_FEMALE) %>%
  mutate(Native_Hawaiian = NHNA_MALE + NHNA_FEMALE) %>%
  mutate(Multiracial = NHTOM_MALE + NHTOM_FEMALE) %>%
  mutate(county = gsub(pattern = "County", replacement = "", ignore.case = TRUE, CTYNAME)) %>%
  mutate(county = gsub(pattern = "^ +| +$", replacement = "", county)) %>%
  mutate(county = gsub(pattern = " {2,}", replacement = " ", county)) %>%
  mutate(county = gsub(pattern = "^[a-z]", replacement = "[A-Z]", county)) %>%
  mutate(state = gsub(pattern = "^ +| +$", replacement = "", STNAME)) %>%
  mutate(state = gsub(pattern = " {2,}", replacement = " ", state)) %>%
  mutate(state = gsub(pattern = "^[a-z]", replacement = "[A-Z]", state)) %>%
  select(county, state, AGEGRP, TOT_POP, White, Black, Hispanic, Asian, Native_American, Native_Hawaiian, Multiracial)

CensusFiltered 
```

## User-Defined Functions

### Percentage Calculation
```{r}
percentage <- function(x, y){
  preRound <- (x/y) * 100
  roundCalc <- round(preRound, digits = 2)
  return(roundCalc)
}
```


## The National Percentage
```{r}
TotalCOVID <- COVIDFiltered %>%
  summarise(sum = sum(cases))
numCases <- TotalCOVID[1,1]
print(numCases)

TotalPop <- CensusFiltered %>%
  filter(AGEGRP != 0) %>% #AGEGRP = 0 sums up the population across all ages.
  summarise(sum = sum(TOT_POP))
popUSA <- TotalPop[1,1]
print(popUSA)

nationalPct <- percentage(numCases, popUSA) #This is an important variable!!
print(nationalPct)
```

## Demographic Percentages 
### Race-Based 
We will now convert our racial population counts into percentages of the population.
```{r}
CensusPctRace <- CensusFiltered %>%
  filter(AGEGRP == 0) %>%
  mutate(WhitePct = percentage(White, TOT_POP)) %>%
  mutate(BlackPct = percentage(Black, TOT_POP)) %>%
  mutate(HispanicPct = percentage(Hispanic, TOT_POP)) %>%
  mutate(AsianPct = percentage(Asian, TOT_POP)) %>%
  mutate(NAPct = percentage(Native_American, TOT_POP)) %>%
  mutate(NHPct = percentage(Native_Hawaiian, TOT_POP)) %>%
  mutate(MultiPct = percentage(Multiracial, TOT_POP)) %>%
  select(county, state, TOT_POP, WhitePct, BlackPct, HispanicPct, AsianPct, NAPct, NHPct, MultiPct)

CensusPctRace
```

### Age-Based
```{r}
CensusPctAge <- CensusFiltered %>%
  select(county, state, TOT_POP, AGEGRP) %>%
  pivot_wider(names_from = AGEGRP, names_prefix = "Group", values_from = TOT_POP) %>%
  mutate(TOTAL = Group0) %>%
  mutate(children = Group1 + Group2 + Group3) %>% 
  mutate(young_adult = Group4 + Group5 + Group6 + Group7 + Group8) %>% 
  mutate(middle_age = Group9 + Group10 + Group11 + Group12 + Group13) %>% 
  mutate(senior = Group14 + Group15 + Group16 + Group17 + Group18) %>% 
  mutate(childrenPct = percentage(children, Group0)) %>% 
  mutate(young_adultPct = percentage(young_adult, Group0)) %>%
  mutate(middle_agePct = percentage(middle_age, Group0)) %>%
  mutate(seniorPct = percentage(senior, Group0)) %>%
  select(county, state, TOTAL, childrenPct, young_adultPct, middle_agePct, seniorPct)

CensusPctAge
```

## Joining the Data
### Using Race
```{r}
RaceJoin <- CensusPctRace %>%
  inner_join(COVIDFiltered) %>%
  mutate(pctCases = percentage(cases, TOT_POP))

RaceJoin
```

### Using Age
```{r}
AgeJoin <- CensusPctAge %>%
  inner_join(COVIDFiltered) %>%
  mutate(pctCases = percentage(cases, TOTAL))

AgeJoin
```

## Highest Demographic Percentages per County
### Race
#### White
```{r}
Top10White <- RaceJoin %>%
  select(county, state, WhitePct, pctCases) %>%
  filter(rank(desc(WhitePct)) <= 10)

Top10White
```

#### Black
```{r}
Top10Black <- RaceJoin %>%
  select(county, state, BlackPct, pctCases) %>%
  filter(rank(desc(BlackPct)) <= 10)

Top10Black
```

#### Hispanic
```{r}
Top10Hispanic <- RaceJoin %>%
  select(county, state, HispanicPct, pctCases) %>%
  filter(rank(desc(HispanicPct)) <= 10)

Top10Hispanic
```

#### Asian
```{r}
Top10Asian <- RaceJoin %>%
  select(county, state, AsianPct, pctCases) %>%
  filter(rank(desc(AsianPct)) <= 10)

Top10Asian
```

#### Native American
```{r}
Top10NA <- RaceJoin %>%
  select(county, state, NAPct, pctCases) %>%
  filter(rank(desc(NAPct)) <= 10)

Top10NA
```

#### Native Hawaiian
```{r}
Top10NH <- RaceJoin %>%
  select(county, state, NHPct, pctCases) %>%
  filter(rank(desc(NHPct)) <= 10)

Top10NH
```

#### Multiracial
```{r}
Top10Multi <- RaceJoin %>%
  select(county, state, MultiPct, pctCases) %>%
  filter(rank(desc(MultiPct)) <= 10)

Top10Multi
```

### Age
#### Children
```{r}
Top10Child <- AgeJoin %>%
  select(county, state, childrenPct, pctCases) %>%
  filter(rank(desc(childrenPct)) <= 10)

Top10Child
```

#### Young Adults
```{r}
Top10YA <- AgeJoin %>%
  select(county, state, young_adultPct, pctCases) %>%
  filter(rank(desc(young_adultPct)) <= 10)

Top10YA
```

#### Middle-Aged
```{r}
Top10Middle <- AgeJoin %>%
  select(county, state, middle_agePct, pctCases) %>%
  filter(rank(desc(middle_agePct)) <= 10)

Top10Middle
```

#### Seniors
```{r}
Top10Senior <- AgeJoin %>%
  select(county, state, seniorPct, pctCases) %>%
  filter(rank(desc(seniorPct)) <= 10)

Top10Senior
```

## The Juicy Stuff: Visualizing our Question!
How do the "Top 10" counties for each demographic stack up to the NATIONAL PERCENTAGE?

### Race
#### White
```{r}
Top10White %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.28)) +
  xlab("Counties w/Highest White Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

#### Black
```{r}
Top10Black %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.28)) +
  xlab("Counties w/Highest Black Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

#### Hispanic
```{r}
Top10Hispanic %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.27)) +
  xlab("Counties w/Highest Hispanic Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

#### Asian
```{r}
Top10Asian %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.3)) +
  xlab("Counties w/Highest Asian Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

#### Native American
```{r}
Top10NA %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.3)) +
  xlab("Counties w/Highest Native American Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

#### Native Hawaiian
```{r}
Top10NH %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.27)) +
  xlab("Counties w/Highest Native Hawaiian Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

#### Multiracial
```{r}
Top10Multi %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.27)) +
  xlab("Counties w/Highest Multiracial Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

### Age
#### Children
```{r}
Top10Child %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.27)) +
  xlab("Counties w/Highest Child Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

#### Young Adults
```{r}
Top10YA %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.28)) +
  xlab("Counties w/Highest Young Adult Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

#### Middle-Aged
```{r}
Top10Middle %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.27)) +
  xlab("Counties w/Highest Middle-Aged Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```

#### Senior
```{r}
Top10Senior %>%
  ggplot(aes(x = county, y = pctCases)) +
  geom_bar(fill = "light blue", stat = "identity") +
  geom_hline(yintercept = nationalPct) +
  geom_text(aes(label = "Nationwide: 0.26%", x = 7, y = 0.27)) +
  xlab("Counties w/Highest Senior Representation") +
  ylab("% of Population w/COVID-19") +
  theme(axis.text.x = element_text(angle = 35))
```